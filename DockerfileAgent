# build stage
FROM golang:1.22 as builder

RUN mkdir /src
WORKDIR /src

COPY ./back-end/models ./back-end/models
COPY ./back-end/agent ./back-end/agent
COPY .env .
COPY kafka.env .
COPY agent.env .
COPY Makefile .

RUN make build-agent

# production stage
FROM alpine:3.19.1
COPY --from=builder /src/api ./api
COPY --from=builder /src/agent_app app

RUN apk update && apk upgrade
RUN apk add musl-dev && apk add libc6-compat
